package com.montydigital.CopsAndRobbers.core
{
	import com.montydigital.CopsAndRobbers.assets.UI;
	import com.montydigital.CopsAndRobbers.ui.citySelect.MapHotSpot;
	import com.montydigital.CopsAndRobbers.ui.common.BackBtn;
	import com.montydigital.gameEngine.core.system.ISystem;
	
	import starling.display.StImage;
	import starling.display.StSprite;
	import starling.events.StTouchEvent;
	import starling.events.Touch;
	import starling.events.TouchPhase;
	
	public class CnR_CitySelect extends StSprite implements ISystem
	{
		public static const LEVEL_SELECT_CITY:String = "levelSelectCity";
		
		private var gameRoot:CnR_GameRoot;
		
		private var map:StImage;
		private var hotSpots:Array;
		private var menuData:XML = new UI.MENU_DATA();
		private var backBtn:BackBtn;
		
		
		public function CnR_CitySelect(root:CnR_GameRoot){
			gameRoot = root;
			
			map = StImage.fromBitmap(new UI.MapBig());
			map.x = this.gameRoot.stage.stageWidth/2 - map.width/2;
			map.y = this.gameRoot.stage.stageHeight/2 - map.height/2;
			
			backBtn = new BackBtn();
			backBtn.x = 20;
			backBtn.y = this.gameRoot.stage.stageHeight - backBtn.height - 20;
			backBtn.touchable = true;
			backBtn.addEventListener(StTouchEvent.TOUCH, handleBackBtn);
			
			addHotSpots();
			
		}
		
		private function addHotSpots():void{
			hotSpots = [];			
			for each(var city:XMLL in menuData){
				var hs:MapHotSpot = new MapHotSpot(city.label, city.flagDir);
				hs.touchable = true;
				hs.addEventListener(StTouchEvent.TOUCH, handleHotSpotClick);
				hs.x = map.x + city.x;
				hs.y = map.y + city.y;
				hotSpots.push(hs);
			}
		}
		
		public function enter():void{
			gameRoot.addChild(this);
			this.addChild(map);
			for each(var hs:MapHotSpot in hotSpots){
				this.addChild(hs);
			}
			this.addChild(backBtn);
		}
		
		public function update():void{
			
		}
		
		public function wait():void{
		}
		
		public function exit():void{
			gameRoot.addChild(this);
			this.removeChild(map);
			for each(var hs:MapHotSpot in hotSpots){
				this.removeChild(hs);
			}
			this.removeChild(backBtn);
		}
		
		private function handleHotSpotClick(e:StTouchEvent):void{
			var touch:Touch;
			for each(var hs:MapHotSpot in hotSpots){
				touch = e.getTouch(hs);
				if(touch && touch.phase == TouchPhase.ENDED){
					gameRoot.selectedCity = hs.city;
					gameRoot.gameFSM.setState(CnR_LevelSelect.LEVEL_SELECT_MAP);
					return;	
				}	
			}
		}
		
		private function handleBackBtn(e:StTouchEvent):void{
			var touch:Touch = e.getTouch(backBtn);
			if(touch && touch.phase ==  TouchPhase.ENDED)
				gameRoot.gameFSM.setState(CnR_StartMenu.START_MENU_BASE);
		}
	}
}