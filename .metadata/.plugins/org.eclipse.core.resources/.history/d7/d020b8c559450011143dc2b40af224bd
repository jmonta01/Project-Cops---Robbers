package com.montydigital.CopsAndRobbers.core.physics{
	import Box2D.Common.Math.b2Vec2;
	import Box2D.Dynamics.b2DebugDraw;
	import Box2D.Dynamics.b2World;
	
	import com.montydigital.CopsAndRobbers.core.physics.box2d.CollisionManager;
	
	import flash.display.Sprite;
	
	import starling.display.StDisplayObject;
	import starling.display.StSprite;

	public class Box2dEngine implements IPhysicsEngine{
		
		public static var debugSprite:Sprite
		public static const RATIO:Number = 30;
		
		private var _b2World:b2World;
		private var gravityVector:b2Vec2;
		private var collisionManager:CollisionManager;
		
		private var timeStep:Number=1/60;
		private var velicotyIterator:int=20;
		private var positionIterator:int=20;		
		
		public function Box2dEngine(debugView:StSprite){
			gravityVector = new b2Vec2(0, 9.8);			
			_b2World = new b2World(gravityVector, false);
			collisionManager = new CollisionManager();
			_b2World.SetContactListener(collisionManager);
			_b2World.SetContactFilter(collisionManager.contactFilter);
			setupDebugMode(debugView);
		}
		
		public function setupDebugMode(debugView:StSprite):void{
			var previewSprite:StSprite = new StSprite();
			Box2dEngine.debugSprite.addChild(previewSprite);
			
			var debugDraw:b2DebugDraw = new b2DebugDraw();
			debugDraw.SetSprite(previewSprite);
			debugDraw.SetDrawScale(RATIO);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
			debugDraw.SetLineThickness(1);
			debugDraw.SetFillAlpha(.3);
			_b2World.SetDebugDraw(debugDraw);

		}
		
		public function start():void{
			
		}
		
		public function update():void{
			_b2World.Step(timeStep, velicotyIterator, positionIterator);
			_b2World.ClearForces();	
//			for(var bb:b2Body = _b2World.GetBodyList(); bb; bb = bb.GetNext()){
//				if(bb.GetUserData() is StDisplayObject){
//					var sprite:StDisplayObject = bb.GetUserData() as StDisplayObject;
//					sprite.x = bb.GetPosition().x * RATIO;
//					sprite.y = bb.GetPosition().y * RATIO;
//					sprite.rotation = bb.GetAngle();
//				}
//			}
		}
		
		public function stop():void{
			
		}
	}
}